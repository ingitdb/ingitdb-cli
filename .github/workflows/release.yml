name: Release

on:
  workflow_dispatch: # Allows manual trigger from Actions tab.

jobs:
  build-linux:
    name: Build Linux & Windows, Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: "1.24.1"

      - name: Setup SSH key for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key
          echo "AUR_SSH_PRIVATE_KEY=$HOME/.ssh/aur_key" >> $GITHUB_ENV

      - uses: goreleaser/goreleaser-action@v7
        with:
          version: v2
          args: release --clean --config .github/goreleaser-linux.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}
          WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goreleaser-dist
          path: dist/
          retention-days: 1

  # See docs/release/homebrew.md for setup instructions
  publish-homebrew:
    name: Publish to Homebrew
    needs:
      - build-linux
    if: "!failure() && !cancelled()"
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: "1.24.1"

      - uses: goreleaser/goreleaser-action@v7
        with:
          version: v2
          args: release --clean --config .github/goreleaser-homebrew.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}
          MACOS_SIGN_P12: ${{ secrets.MACOS_SIGN_P12 }}
          MACOS_SIGN_PASSWORD: ${{ secrets.MACOS_SIGN_PASSWORD }}
          NOTARIZE_ISSUER_ID: ${{ secrets.NOTARIZE_ISSUER_ID }}
          NOTARIZE_KEY_ID: ${{ secrets.NOTARIZE_KEY_ID }}
          NOTARIZE_KEY: ${{ secrets.NOTARIZE_KEY }}

  # See docs/release/snapcraft.md for setup instructions
  publish-snap:
    name: Publish to Snapcraft
    needs:
      - build-linux
    if: "!failure() && !cancelled()"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: "1.24.1"

      - name: Install snapcraft
        run: sudo snap install snapcraft --classic

      - uses: goreleaser/goreleaser-action@v7
        with:
          version: v2
          args: release --clean --config .github/goreleaser-publish-snap.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}

  deploy-server:
    name: Deploy to Cloud Run
    needs:
      - build-linux
    if: "!failure() && !cancelled()"
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
      packages: "read"

    steps:
      - uses: actions/checkout@v6

      - name: Deploy to Cloud Run
        uses: ./.github/actions/deploy-to-cloud-run
        with:
          gcloud_project_id: ${{ vars.GCLOUD_PROJECT_ID || 'ingitdb' }}
          gcloud_region: ${{ vars.GCLOUD_REGION || 'europe-west3' }}
          service_name: ${{ vars.SERVICE_NAME || 'ingitdb-server' }}
          ingitdb_github_oauth_client_id: ${{ vars.INGITDB_GITHUB_OAUTH_CLIENT_ID }}
          ingitdb_github_oauth_callback_url: ${{ vars.INGITDB_GITHUB_OAUTH_CALLBACK_URL }}
          ingitdb_auth_cookie_domain: ${{ vars.INGITDB_AUTH_COOKIE_DOMAIN }}
          ingitdb_auth_api_base_url: ${{ vars.INGITDB_AUTH_API_BASE_URL }}
          ingitdb_auth_cookie_name: ${{ vars.INGITDB_AUTH_COOKIE_NAME || 'ingitdb_session' }}
          ingitdb_auth_cookie_secure: ${{ vars.INGITDB_AUTH_COOKIE_SECURE || 'true' }}
          gcp_oauth_client_secret_name: ${{ vars.GCP_OAUTH_CLIENT_SECRET_NAME }}
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER || 'projects/152447355531/locations/global/workloadIdentityPools/github/providers/ingitdb' }}
