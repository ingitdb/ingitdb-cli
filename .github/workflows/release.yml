name: Release

on:
  workflow_dispatch: # Allows manual trigger from Actions tab
#  push:
#    tags: [ 'v*' ]

jobs:
  build-linux:
    name: Build Linux & Windows, Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Setup SSH key for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key
          echo "AUR_SSH_PRIVATE_KEY=$HOME/.ssh/aur_key" >> $GITHUB_ENV

      - uses: goreleaser/goreleaser-action@v7
        with:
          version: v2
          args: release --clean --config .github/goreleaser-linux.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}

  macos-releaser:
    name: Build, Sign & Notarize macOS
    needs:
      - build-linux
    if: always() && !failure() && !cancelled()
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - uses: goreleaser/goreleaser-action@v7
        with:
          version: v2
          args: release --clean --config .github/goreleaser-macos.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}
          MACOS_SIGN_P12: ${{ secrets.MACOS_SIGN_P12 }}
          MACOS_SIGN_PASSWORD: ${{ secrets.MACOS_SIGN_PASSWORD }}
          NOTARIZE_ISSUER_ID: ${{ secrets.NOTARIZE_ISSUER_ID }}
          NOTARIZE_KEY_ID: ${{ secrets.NOTARIZE_KEY_ID }}
          NOTARIZE_KEY: ${{ secrets.NOTARIZE_KEY }}

  publish-snap:
    name: Publish to Snapcraft
    needs:
      - build-linux
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Install snapcraft
        run: sudo snap install snapcraft --classic

      - uses: goreleaser/goreleaser-action@v7
        with:
          version: v2
          args: release --clean --config .github/goreleaser-publish-snap.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}

  deploy-server:
    name: Deploy to Cloud Run
    needs:
      - build-linux
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'read'

    steps:
      - uses: actions/checkout@v6

      - name: Deploy to Cloud Run
        uses: ./.github/actions/deploy-to-cloud-run
        with:
          gcloud_project_id: ${{ vars.GCLOUD_PROJECT_ID || 'ingitdb' }}
          gcloud_region: ${{ vars.GCLOUD_REGION || 'europe-west3' }}
          service_name: ${{ vars.SERVICE_NAME || 'ingitdb-server' }}
          ingitdb_github_oauth_client_id: ${{ vars.INGITDB_GITHUB_OAUTH_CLIENT_ID }}
          ingitdb_github_oauth_callback_url: ${{ vars.INGITDB_GITHUB_OAUTH_CALLBACK_URL }}
          ingitdb_auth_cookie_domain: ${{ vars.INGITDB_AUTH_COOKIE_DOMAIN }}
          ingitdb_auth_api_base_url: ${{ vars.INGITDB_AUTH_API_BASE_URL }}
          ingitdb_auth_cookie_name: ${{ vars.INGITDB_AUTH_COOKIE_NAME || 'ingitdb_session' }}
          ingitdb_auth_cookie_secure: ${{ vars.INGITDB_AUTH_COOKIE_SECURE || 'true' }}
          gcp_oauth_client_secret_name: ${{ vars.GCP_OAUTH_CLIENT_SECRET_NAME }}
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER || 'projects/152447355531/locations/global/workloadIdentityPools/github/providers/ingitdb' }}

  deploy-website:
    name: Deploy Website
    needs:
      - build-linux
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v6

      - name: Deploy website
        uses: ./.github/actions/deploy-website
        with:
          gcloud_project_id: ${{ vars.GCLOUD_PROJECT_ID || 'ingitdb' }}
          firebase_target: ${{ vars.FIREBASE_TARGET || 'ingitdb-com' }}
          firebase_config_path: server/firebase.json
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER || 'projects/152447355531/locations/global/workloadIdentityPools/github/providers/ingitdb' }}
          node_version: "20"
